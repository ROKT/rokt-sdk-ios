name: CI â€“ Size Report

on:
  workflow_call:

concurrency:
  group: size-report-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

env:
  COMMENT_IDENTIFIER: <!-- sdk-size-report -->

jobs:
  measure-size:
    runs-on: macos-latest-xlarge
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          path: pr-branch

      - name: Checkout target branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.pull_request.base.sha || 'main' }}
          path: base-branch

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1.6.0
        with:
          xcode-version: "16.4"

      - name: Build and measure target branch
        id: base-size
        working-directory: base-branch
        continue-on-error: true
        run: |
          if [[ -d "Tests/SizeReport/SizeTestAppWithSDK" ]] && [[ -d "Tests/SizeReport/SizeTestApp" ]] && [[ -f "Tests/SizeReport/measure_size.sh" ]]; then
            chmod +x Tests/SizeReport/measure_size.sh
            RESULT=$(Tests/SizeReport/measure_size.sh --json 2>/dev/null)
            if [[ $? -eq 0 ]] && [[ -n "$RESULT" ]]; then
              SDK_IMPACT_KB=$(echo "$RESULT" | python3 -c 'import json,sys; print(int(json.load(sys.stdin).get("sdk_impact_kb", 0)))')
              SDK_FRAMEWORK_SIZE_KB=$(echo "$RESULT" | python3 -c 'import json,sys; print(int(json.load(sys.stdin).get("sdk_framework_size_kb", 0)))')
              echo "json=${RESULT}" >> "$GITHUB_OUTPUT"
              echo "sdk_impact_kb=${SDK_IMPACT_KB}" >> "$GITHUB_OUTPUT"
              echo "sdk_framework_size_kb=${SDK_FRAMEWORK_SIZE_KB}" >> "$GITHUB_OUTPUT"
              echo "exists=true" >> "$GITHUB_OUTPUT"
            else
              echo "json={\"sdk_impact_kb\": 0, \"sdk_framework_size_kb\": 0}" >> "$GITHUB_OUTPUT"
              echo "sdk_impact_kb=0" >> "$GITHUB_OUTPUT"
              echo "sdk_framework_size_kb=0" >> "$GITHUB_OUTPUT"
              echo "exists=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "json={\"sdk_impact_kb\": 0, \"sdk_framework_size_kb\": 0}" >> "$GITHUB_OUTPUT"
            echo "sdk_impact_kb=0" >> "$GITHUB_OUTPUT"
            echo "sdk_framework_size_kb=0" >> "$GITHUB_OUTPUT"
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build and measure PR branch
        id: pr-size
        working-directory: pr-branch
        continue-on-error: true
        run: |
          if [[ -d "Tests/SizeReport/SizeTestAppWithSDK" ]] && [[ -d "Tests/SizeReport/SizeTestApp" ]] && [[ -f "Tests/SizeReport/measure_size.sh" ]]; then
            chmod +x Tests/SizeReport/measure_size.sh
            RESULT=$(Tests/SizeReport/measure_size.sh --json 2>/dev/null)
            if [[ $? -eq 0 ]] && [[ -n "$RESULT" ]]; then
              SDK_IMPACT_KB=$(echo "$RESULT" | python3 -c 'import json,sys; print(int(json.load(sys.stdin).get("sdk_impact_kb", 0)))')
              SDK_FRAMEWORK_SIZE_KB=$(echo "$RESULT" | python3 -c 'import json,sys; print(int(json.load(sys.stdin).get("sdk_framework_size_kb", 0)))')
              echo "json=${RESULT}" >> "$GITHUB_OUTPUT"
              echo "sdk_impact_kb=${SDK_IMPACT_KB}" >> "$GITHUB_OUTPUT"
              echo "sdk_framework_size_kb=${SDK_FRAMEWORK_SIZE_KB}" >> "$GITHUB_OUTPUT"
              echo "exists=true" >> "$GITHUB_OUTPUT"
            else
              echo "json={\"sdk_impact_kb\": 0, \"sdk_framework_size_kb\": 0}" >> "$GITHUB_OUTPUT"
              echo "sdk_impact_kb=0" >> "$GITHUB_OUTPUT"
              echo "sdk_framework_size_kb=0" >> "$GITHUB_OUTPUT"
              echo "exists=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "json={\"sdk_impact_kb\": 0, \"sdk_framework_size_kb\": 0}" >> "$GITHUB_OUTPUT"
            echo "sdk_impact_kb=0" >> "$GITHUB_OUTPUT"
            echo "sdk_framework_size_kb=0" >> "$GITHUB_OUTPUT"
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Calculate size delta
        id: delta
        run: |
          BASE_EXISTS=${{ steps.base-size.outputs.exists }}
          PR_EXISTS=${{ steps.pr-size.outputs.exists }}
          BASE_SDK_IMPACT=${{ steps.base-size.outputs.sdk_impact_kb }}
          PR_SDK_IMPACT=${{ steps.pr-size.outputs.sdk_impact_kb }}
          BASE_FRAMEWORK=${{ steps.base-size.outputs.sdk_framework_size_kb }}
          PR_FRAMEWORK=${{ steps.pr-size.outputs.sdk_framework_size_kb }}

          if [[ "$BASE_EXISTS" != "true" ]] || [[ "$PR_EXISTS" != "true" ]] || [[ "$BASE_SDK_IMPACT" -eq 0 ]]; then
            echo "delta_kb=N/A" >> "$GITHUB_OUTPUT"
            echo "delta_framework=N/A" >> "$GITHUB_OUTPUT"
            echo "delta_percent=N/A" >> "$GITHUB_OUTPUT"
            echo "status=unavailable" >> "$GITHUB_OUTPUT"
          else
            DELTA_KB=$((PR_SDK_IMPACT - BASE_SDK_IMPACT))
            DELTA_FRAMEWORK=$((PR_FRAMEWORK - BASE_FRAMEWORK))

            if [[ "$BASE_SDK_IMPACT" -gt 0 ]]; then
              DELTA_PERCENT=$(awk "BEGIN {printf \"%.2f\", ($DELTA_KB / $BASE_SDK_IMPACT) * 100}")
            else
              DELTA_PERCENT="0.00"
            fi

            echo "delta_kb=${DELTA_KB}" >> "$GITHUB_OUTPUT"
            echo "delta_framework=${DELTA_FRAMEWORK}" >> "$GITHUB_OUTPUT"
            echo "delta_percent=${DELTA_PERCENT}" >> "$GITHUB_OUTPUT"

            if [[ "$DELTA_KB" -gt 50 ]]; then
              echo "status=increase" >> "$GITHUB_OUTPUT"
            elif [[ "$DELTA_KB" -lt -50 ]]; then
              echo "status=decrease" >> "$GITHUB_OUTPUT"
            else
              echo "status=neutral" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Format size for display
        id: format
        run: |
          BASE_EXISTS=${{ steps.base-size.outputs.exists }}
          PR_EXISTS=${{ steps.pr-size.outputs.exists }}

          format_size() {
            local kb="$1"
            if [[ "$kb" == "0" || "$kb" == "N/A" ]]; then
              echo "N/A"
            elif [[ "$kb" -ge 1024 ]]; then
              awk "BEGIN {printf \"%.2f MB\", $kb / 1024}"
            else
              echo "${kb} KB"
            fi
          }

          if [[ "$BASE_EXISTS" == "true" ]]; then
            echo "base_impact_formatted=$(format_size ${{ steps.base-size.outputs.sdk_impact_kb }})" >> "$GITHUB_OUTPUT"
            echo "base_framework_formatted=$(format_size ${{ steps.base-size.outputs.sdk_framework_size_kb }})" >> "$GITHUB_OUTPUT"
          else
            echo "base_impact_formatted=N/A" >> "$GITHUB_OUTPUT"
            echo "base_framework_formatted=N/A" >> "$GITHUB_OUTPUT"
          fi

          if [[ "$PR_EXISTS" == "true" ]]; then
            echo "pr_impact_formatted=$(format_size ${{ steps.pr-size.outputs.sdk_impact_kb }})" >> "$GITHUB_OUTPUT"
            echo "pr_framework_formatted=$(format_size ${{ steps.pr-size.outputs.sdk_framework_size_kb }})" >> "$GITHUB_OUTPUT"
          else
            echo "pr_impact_formatted=N/A" >> "$GITHUB_OUTPUT"
            echo "pr_framework_formatted=N/A" >> "$GITHUB_OUTPUT"
          fi

          DELTA_KB="${{ steps.delta.outputs.delta_kb }}"
          DELTA_FRAMEWORK="${{ steps.delta.outputs.delta_framework }}"

          if [[ "$DELTA_KB" != "N/A" ]]; then
            if [[ "$DELTA_KB" -ge 0 ]]; then
              echo "delta_formatted=+$(format_size "$DELTA_KB")" >> "$GITHUB_OUTPUT"
            else
              echo "delta_formatted=$(format_size "$DELTA_KB")" >> "$GITHUB_OUTPUT"
            fi
            if [[ "$DELTA_FRAMEWORK" -ge 0 ]]; then
              echo "delta_framework_formatted=+$(format_size "$DELTA_FRAMEWORK")" >> "$GITHUB_OUTPUT"
            else
              echo "delta_framework_formatted=$(format_size "$DELTA_FRAMEWORK")" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "delta_formatted=N/A" >> "$GITHUB_OUTPUT"
            echo "delta_framework_formatted=N/A" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate size report
        id: report
        run: |
          REPORT_FILE="${RUNNER_TEMP}/size-report.md"
          STATUS="${{ steps.delta.outputs.status }}"
          case "$STATUS" in
            increase) STATUS_MSG="âš ï¸ This change increases SDK size impact." ;;
            decrease) STATUS_MSG="âœ… This change decreases SDK size impact." ;;
            neutral) STATUS_MSG="âž¡ï¸ SDK size impact change is minimal." ;;
            unavailable) STATUS_MSG="â„¹ï¸ Size report tooling is not available on one or both branches." ;;
            *) STATUS_MSG="" ;;
          esac

          cat > "$REPORT_FILE" << EOF
          ${{ env.COMMENT_IDENTIFIER }}
          ## ðŸ“¦ SDK Size Impact Report

          Measures how much the SDK adds to an app's size (framework + resources).

          | Metric | Target Branch | This PR | Change |
          |--------|---------------|---------|--------|
          | Total SDK Impact | ${{ steps.format.outputs.base_impact_formatted }} | ${{ steps.format.outputs.pr_impact_formatted }} | ${{ steps.format.outputs.delta_formatted }} |
          | Framework Size | ${{ steps.format.outputs.base_framework_formatted }} | ${{ steps.format.outputs.pr_framework_formatted }} | ${{ steps.format.outputs.delta_framework_formatted }} |

          ${STATUS_MSG}

          <details>
          <summary>Raw measurements</summary>

          **Target branch (${{ github.base_ref || 'main' }}):**
          \`\`\`json
          ${{ steps.base-size.outputs.json }}
          \`\`\`

          **This PR:**
          \`\`\`json
          ${{ steps.pr-size.outputs.json }}
          \`\`\`
          </details>
          EOF

          sed -i.bak 's/^          //' "$REPORT_FILE" && rm -f "${REPORT_FILE}.bak"
          echo "path=${REPORT_FILE}" >> "$GITHUB_OUTPUT"

      - name: Find Comment
        if: github.event_name == 'pull_request'
        uses: peter-evans/find-comment@v4
        id: fc
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: github-actions[bot]
          body-includes: ${{ env.COMMENT_IDENTIFIER }}

      - name: Create or update PR comment
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v5
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body-path: ${{ steps.report.outputs.path }}

      - name: Upload size report artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: size-report
          path: ${{ steps.report.outputs.path }}

      - name: Write job summary
        run: cat "${{ steps.report.outputs.path }}" >> "$GITHUB_STEP_SUMMARY"
